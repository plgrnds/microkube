---
- name: create calico rbac
  become: yes
  become_user: "{{ k8user }}"
  shell: kubectl apply -f https://docs.projectcalico.org/v3.2/getting-started/kubernetes/installation/hosted/rbac-kdd.yaml
  args:
    chdir: $HOME
    creates: calico_role_setup.txt

- name: copy calico resource config
  become: yes
  template:
    src: "{{ item }}"
    dest: "{{ k8s_addons_dir }}/{{ item }}"
  with_items:
    - calico.yaml
    - felix-config.yaml

- name: install calico 
  become: yes
  become_user: "{{ k8user }}"
  command: kubectl apply -f "{{ k8s_addons_dir }}/calico.yaml"
  args:
    chdir: $HOME
    creates: calico_pod_network_setup.txt

# - name: update config calico 
#   become: yes
#   become_user: "{{ k8user }}"
#   command: kubectl apply -f "{{ k8s_addons_dir }}/felix-config.yaml"
#   args:
#     chdir: $HOME
#     creates: calico_config_updated.txt


# - name: install Pod network
#   become: yes
#   become_user: '{{ k8user }}'
#   shell: kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/v0.9.1/Documentation/kube-flannel.yml >> pod_network_setup.txt
#   args:
#     chdir: $HOME
#     creates: pod_network_setup.txt
